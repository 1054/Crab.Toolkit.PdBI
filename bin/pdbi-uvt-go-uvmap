#!/bin/bash
# 
# Input uvt
# Output lmv, eps
# 
# Last update:
#    2017-02-19 rewritten, beautified, used "pdbi-uvt-core-arg"
#    2017-03-30 using "pdbi-uvt-core-arg-v5"
#    2017-04-09 Now output "*.lmv.fits"
# 
# 



# 
# Uage
# 
usage() {
    echo "Usage: "
    echo "  pdbi-uvt-go-uvmap -name aaa.uvt -size 15 -map_size 512 -map_cell 0.2 -out aaa.eps -overwrite"
    echo ""
}



# 
# SOURCE pdbi-uvt-core-arg
# 
if [[ -f $(dirname "${BASH_SOURCE[0]}")"/pdbi-uvt-core-arg-v5" ]]; then
    source $(dirname "${BASH_SOURCE[0]}")"/pdbi-uvt-core-arg-v5" "$@"
else
    echo ""
    echo "Error! Could not find \""$(dirname "${BASH_SOURCE[0]}")"/pdbi-uvt-core-arg-v5\"!"
    echo ""
    exit 1
fi



# 
# Check input parameters -- uvt file name
# 
if [[ ${#PdBIUVT_NAME[@]} -eq 0 ]]; then
    usage; exit
fi



# 
# Loop input uv tables
# 
for (( i = 0; i < "${#PdBIUVT_NAME[@]}"; i++ )); do
    # 
    # if type is uvtable
    # 
    if [[ ${PdBIUVT_TYPE[i]} == "uvt" || ${PdBIUVT_TYPE[i]} == "UVT" ]]; then
        # 
        # Set default output file name
        # 
        if [[ ${#PdBIUVT_SAVE[@]} -le $i ]]; then
            PdBIUVT_SAVE+=("${PdBIUVT_NAME[i]}")
        fi
        if [[ x"${PdBIUVT_SAVE[i]}" == x || x"${PdBIUVT_SAVE[i]}" == x"tmp_pdbi_uvt" ]]; then 
            PdBIUVT_SAVE[i]="${PdBIUVT_NAME[i]}"
            echo ""; echo "Warning! Output name was not given for the input uvtable \"${PdBIUVT_NAME[i]}\", setting to \"${PdBIUVT_SAVE[i]}\""; echo ""
        fi
        # 
        # Remove suffix
        # 
        if [[ x"${PdBIUVT_SAVE[i]}" == x*".eps" ]]; then
            PdBIUVT_SAVE[i]=$(echo "${PdBIUVT_SAVE[i]}" | sed -e 's/\.eps$//g')
        fi
        if [[ x"${PdBIUVT_SAVE[i]}" == x*".EPS" ]]; then
            PdBIUVT_SAVE[i]=$(echo "${PdBIUVT_SAVE[i]}" | sed -e 's/\.EPS$//g')
        fi
        # 
        # Backup existing output file
        # 
        if [[ -f "${PdBIUVT_SAVE[i]}.eps" ]]; then
            echo "Warning! Found existing \"${PdBIUVT_SAVE[i]}.eps\"! Backup as \"${PdBIUVT_SAVE[i]}.eps.backup\"!"
            mv "${PdBIUVT_SAVE[i]}.eps" "${PdBIUVT_SAVE[i]}.eps.backup"
        fi
        # 
        # 
        # Deal with the input uvt file
        # Output to mapping script
        # "$PdBIUVT_NAME.uvt.go.uvmap.script"
        # 
        PdBIUVT_EXE="${PdBIUVT_NAME[i]}.${PdBIUVT_TYPE[i]}.uv_map.script"
        PdBIUVT_LOG="${PdBIUVT_NAME[i]}.${PdBIUVT_TYPE[i]}.uv_map.log"
        PdBIUVT_INI="${PdBIUVT_NAME[i]}.${PdBIUVT_TYPE[i]}.uv_map.init" #<TODO>
        PdBIUVT_EPS="${PdBIUVT_SAVE[i]}"
        
        #echo "" > "$PdBIUVT_INI"
        #echo 'TASK\FILE      "UV table" UV_TABLE$ "'${PdBIUVT_NAME[i]}'"'
        #echo 'TASK\CHARACTER "Map name" MAP_NAME$ "'${PdBIUVT_NAME[i]}'"'
        #echo 'TASK\REAL      "UV taper (1/e level) [m]" UV_TAPER$[4]  0 0 0 0'
        #echo 'TASK\CHARACTER "Weight mode (NA or UN)" WEIGHT_MODE$ "NA"'
        #echo 'TASK\REAL      "Field of view [arc sec]" MAP_FIELD$[2]  0 0'
        #echo 'TASK\INTEGER   "Map size [pixel]" MAP_SIZE$[2]  0 0'
        #echo 'TASK\REAL      "Map cell [arc sec]" MAP_CELL$[2]  0 0'
        #echo 'TASK\REAL      "UV cell [m], for unif. weighting" UV_CELL$[2]  7.5 1'
        #echo 'TASK\LOGICAL   "Make one beam (NO), or one per channel (YES)" ONEBEAM$ NO'
        #echo 'TASK\INTEGER   "Weight channel" WCOL$ 0'
        #echo 'TASK\INTEGER   "Beam channel" BCOL$ 0'
        #echo 'TASK\INTEGER   "First and Last channel to map" MCOL$[2]  0 0'
        #echo 'TASK\INTEGER   "Convolution function [0-5]" CONVOLUTION$ 5'
        #echo '!'
        #echo 'TASK\LOGICAL   "Change map center or map orientation" UV_SHIFT$ NO'
        #echo 'TASK\CHARACTER "Map Center RA" RA_CENTER$ "0"'
        #echo 'TASK\CHARACTER "Map Center DEC" DEC_CENTER$ "0"'
        #echo 'TASK\REAL      "Map Position Angle [deg]" ANGLE$ 0'
        #echo 'TASK\GO'
        
        
        echo "! GILDAS MAPPING SCRIPT"         >  "$PdBIUVT_EXE"
        echo ""                                >> "$PdBIUVT_EXE"
        echo "let name \"${PdBIUVT_NAME[i]}\"" >> "$PdBIUVT_EXE"
        
        if [[ ${#PdBIUVT_SIZE[@]}     -gt 0 ]]; then echo "let size ${PdBIUVT_SIZE[0]}"          >> "$PdBIUVT_EXE"; PdBIUVT_EPS="${PdBIUVT_EPS}_FoV_"$(printf "%.0f" ${PdBIUVT_SIZE[0]})"_arcsec"; fi
        if [[ ${#PdBIUVT_MAP_SIZE[@]} -gt 0 ]]; then echo "let map_size ${PdBIUVT_MAP_SIZE[0]}"  >> "$PdBIUVT_EXE"; fi
        if [[ ${#PdBIUVT_MAP_CELL[@]} -gt 0 ]]; then echo "let map_cell ${PdBIUVT_MAP_CELL[0]}"  >> "$PdBIUVT_EXE"; fi
        
        if [[ -f "${PdBIUVT_SAVE[i]}.lmv.fits" ]]; then
            mv "${PdBIUVT_SAVE[i]}.lmv.fits" "${PdBIUVT_SAVE[i]}.lmv.fits.backup"
        fi
        
        #echo "say \"\""                         >> "$PdBIUVT_EXE"
        #echo "say \"uv_map\""                   >> "$PdBIUVT_EXE"
        #echo "say \"\""                         >> "$PdBIUVT_EXE"
        #echo "@ p_setup.map inter"              >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "let map_size used%size"           >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "let map_cell used%cell"           >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "uv_map"                           >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map -- <TODO> THIS CAN NOT BE APPLIED TO MOSAIC UV DATA
        ##echo "fit"                             >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "on error fit"                     >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "write dirty 'name'.lmv"           >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        #echo "write beam 'name'.beam"           >> "$PdBIUVT_EXE" # -- see *-exe-*/pro/p_uvmap.map
        
        #echo "say \"\""             >> "$PdBIUVT_EXE"
        #echo "say \"go noise\""     >> "$PdBIUVT_EXE"
        #echo "say \"\""             >> "$PdBIUVT_EXE"
        #echo "go noise"             >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"on error continue\""    >> "$PdBIUVT_EXE"
        echo "on error continue"            >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"go uvmap\""             >> "$PdBIUVT_EXE"
        echo "go uvmap"                     >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"go noise\""             >> "$PdBIUVT_EXE"
        echo "go noise"                     >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "let spacing noise"            >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"examine map_size\""     >> "$PdBIUVT_EXE"
        echo "exam map_size"                >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"examine map_cell\""     >> "$PdBIUVT_EXE"
        echo "exam map_cell"                >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"examine noise\""        >> "$PdBIUVT_EXE"
        echo "exam noise"                   >> "$PdBIUVT_EXE"
        
        echo ""                                                 >> "$PdBIUVT_EXE"
        echo "say \"\""                                         >> "$PdBIUVT_EXE"
        echo "say \"fits\""                                     >> "$PdBIUVT_EXE"
        echo "fits 'name'.lmv.fits from 'name'.lmv /overwrite"  >> "$PdBIUVT_EXE"
        
        echo ""                             >> "$PdBIUVT_EXE"
        echo "say \"\""                     >> "$PdBIUVT_EXE"
        echo "say \"go view\""              >> "$PdBIUVT_EXE"
        echo "go view"                      >> "$PdBIUVT_EXE"
        
        # 
        # Overwrite or not (always overwrite)
        # 
        if [[ -f "${PdBIUVT_EPS}.eps" ]]; then
            mv "${PdBIUVT_EPS}.eps" "${PdBIUVT_EPS}.eps.backup"
        fi
        echo ""                                              >> "$PdBIUVT_EXE"
        echo "hardcopy \"${PdBIUVT_EPS}.eps\" /overwrite"    >> "$PdBIUVT_EXE"
        echo "sys \"ps2pdf -dEPSCrop ${PdBIUVT_EPS}.eps\""   >> "$PdBIUVT_EXE"
        #if [[ "$PdBIUVT_OVERWRITE" == "YES" ]]; then
        #    echo "hardcopy \"${PdBIUVT_EPS}.eps\" /overwrite"    >> "$PdBIUVT_EXE"
        #    echo "sys \"ps2pdf -dEPSCrop ${PdBIUVT_EPS}.eps\""   >> "$PdBIUVT_EXE"
        #else
        #    echo "hardcopy \"${PdBIUVT_EPS}.eps\""               >> "$PdBIUVT_EXE"
        #    echo "sys \"ps2pdf -dEPSCrop ${PdBIUVT_EPS}.eps\""   >> "$PdBIUVT_EXE"
        #fi
        
        # 
        # Run mapping script
        # 
        # -- must wait for other mapping processes (for example when another uv_merge is running... strange though)
        echo "@$PdBIUVT_EXE" | mapping -nw -nl | tee "$PdBIUVT_LOG" 
        PdBIUVT_REPEAT=0
        while [[ ! -f "${PdBIUVT_EPS}.eps" || ! -f "${PdBIUVT_SAVE[i]}.lmv" || ! -f "${PdBIUVT_SAVE[i]}.lmv.fits" ]]; do
            echo "Failed to get the uv_map result? Perhaps conflicting with other running mapping processes! Try again!"; sleep 1.0
            echo "@$PdBIUVT_EXE" | mapping -nw -nl | tee "$PdBIUVT_LOG" 
            PdBIUVT_REPEAT=$(($PdBIUVT_REPEAT+1))
            # repeat running it
        done
        
        # 
        # Check output
        # 
        if [[ -f "${PdBIUVT_EPS}.eps" ]]; then
            echo "Successufully saved to \"${PdBIUVT_EPS}.eps\"!"
            echo "--"
            #if [[ -f "$PdBIUVT_LOG" ]]; then
            #    rm "$PdBIUVT_LOG"
            #fi
        else
            echo "Error! Failed to run GILDAS MAPPING UV_MAP and output \"${PdBIUVT_EPS}.eps\"!"
            echo "Please check \"$PdBIUVT_LOG\"!"
            exit 1
        fi
        
    fi
    
done














